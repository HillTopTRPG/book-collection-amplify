name: Lighthouse

permissions:
  contents: read
  actions: write

on:
  push:
    branches: [main, feature/**]
    paths-ignore:
      - '**/*.md'
      # - '**/*.yml'
      - '**/*.yaml'
      - '.gitignore'
      - 'LICENSE'
      - 'CONTRIBUTING.md'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js lts
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          # Try npm ci first, fall back to npm install if it fails
          npm ci || (echo "npm ci failed, falling back to npm install" && npm install)

      - name: Save node_modules to cache
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}

      - name: Create mock amplify_outputs.json
        run: |
          cat > amplify_outputs.json << 'EOF'
          {
            "auth": {
              "user_pool_id": "mock-user-pool-id",
              "aws_region": "us-east-1",
              "user_pool_client_id": "mock-client-id",
              "identity_pool_id": "mock-identity-pool-id",
              "mfa_methods": [],
              "standard_required_attributes": ["email"],
              "username_attributes": ["email"],
              "user_verification_types": ["email"],
              "groups": [],
              "mfa_configuration": "NONE",
              "password_policy": {
                "min_length": 8,
                "require_lowercase": true,
                "require_numbers": true,
                "require_symbols": true,
                "require_uppercase": true
              },
              "unauthenticated_identities_enabled": true
            },
            "data": {
              "url": "https://mock-api-url.amazonaws.com/graphql",
              "aws_region": "us-east-1",
              "api_key": "mock-api-key",
              "default_authorization_type": "AMAZON_COGNITO_USER_POOLS",
              "authorization_types": ["API_KEY", "AWS_IAM"],
              "model_introspection": {
                "version": 1,
                "models": {
                  "Collection": {
                    "name": "Collection",
                    "fields": {
                      "id": {"name": "id", "isArray": false, "type": "ID", "isRequired": true, "attributes": []},
                      "isbn": {"name": "isbn", "isArray": false, "type": "String", "isRequired": true, "attributes": []},
                      "meta": {"name": "meta", "isArray": false, "type": "String", "isRequired": true, "attributes": []},
                      "memo": {"name": "memo", "isArray": false, "type": "String", "isRequired": false, "attributes": []}
                    },
                    "syncable": true,
                    "pluralName": "Collections",
                    "attributes": [{"type": "model", "properties": {}}],
                    "primaryKeyInfo": {"isCustomPrimaryKey": false, "primaryKeyFieldName": "id", "sortKeyFieldNames": []}
                  },
                  "FilterSet": {
                    "name": "FilterSet",
                    "fields": {
                      "id": {"name": "id", "isArray": false, "type": "ID", "isRequired": true, "attributes": []},
                      "name": {"name": "name", "isArray": false, "type": "String", "isRequired": true, "attributes": []},
                      "filters": {"name": "filters", "isArray": false, "type": "String", "isRequired": true, "attributes": []}
                    },
                    "syncable": true,
                    "pluralName": "FilterSets",
                    "attributes": [{"type": "model", "properties": {}}],
                    "primaryKeyInfo": {"isCustomPrimaryKey": false, "primaryKeyFieldName": "id", "sortKeyFieldNames": []}
                  }
                },
                "enums": {},
                "nonModels": {}
              }
            },
            "version": "1.4"
          }
          EOF

      - name: Build application
        run: npm run build

      - name: Cache Chrome
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-chrome-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-chrome-

      - name: Audit performance with Lighthouse CI
        run: |
          npx lhci autorun || echo "Lighthouse CI completed with issues"

          # Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞: „Éï„Ç°„Ç§„É´ÁîüÊàêÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
          echo "=== Lighthouse CI Results Debug ==="
          echo "Working directory: $(pwd)"
          echo "Directory contents:"
          ls -la

          # ÂèØËÉΩÊÄß„ÅÆ„ÅÇ„Çã„Åô„Åπ„Å¶„ÅÆÂ†¥ÊâÄ„ÇíÁ¢∫Ë™ç
          for dir in .lighthouseci lhci_reports lighthouse-reports; do
            if [ -d "$dir" ]; then
              echo "‚úÖ $dir directory exists"
              echo "Contents of $dir:"
              ls -la "$dir/"
            else
              echo "‚ùå $dir directory not found"
            fi
          done

          # LighthouseÈñ¢ÈÄ£„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂÖ®Ê§úÁ¥¢
          echo "Searching for Lighthouse files..."
          find . -name "*.json" -o -name "*.html" | grep -E "(lh|lighthouse)" || echo "No lighthouse files found"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      - name: Prepare artifacts directory
        if: always()
        run: |
          # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁî®„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
          mkdir -p lighthouse-artifacts

          # Â≠òÂú®„Åô„ÇãÁµêÊûú„Çí„Åô„Åπ„Å¶ÂèéÈõÜ
          for dir in .lighthouseci lhci_reports lighthouse-reports; do
            if [ -d "$dir" ] && [ -n "$(ls -A "$dir/" 2>/dev/null)" ]; then
              echo "Copying contents from $dir"
              cp -r "$dir"/* lighthouse-artifacts/ 2>/dev/null || echo "No files to copy from $dir"
            fi
          done

          # Áõ¥Êé•ÁöÑ„Å™„Éï„Ç°„Ç§„É´Ê§úÁ¥¢„ÇÇ„Åô„Çã
          find . -maxdepth 2 -name "lhr-*.json" -exec cp {} lighthouse-artifacts/ \; 2>/dev/null || true
          find . -maxdepth 2 -name "lhr-*.html" -exec cp {} lighthouse-artifacts/ \; 2>/dev/null || true

          echo "Final artifacts directory contents:"
          ls -la lighthouse-artifacts/

      - name: Generate Lighthouse summary
        if: always()
        run: |
          # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁî®„Éá„Ç£„É¨„ÇØ„Éà„É™„Åã„ÇâJSON„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô
          LATEST_REPORT=""
          if ls lighthouse-artifacts/lhr-*.json 1> /dev/null 2>&1; then
            LATEST_REPORT=$(ls -t lighthouse-artifacts/lhr-*.json | head -n1)
          elif ls lighthouse-artifacts/*.json 1> /dev/null 2>&1; then
            LATEST_REPORT=$(ls -t lighthouse-artifacts/*.json | head -n1)
          fi

          if [ -f "$LATEST_REPORT" ]; then
            echo "‚úÖ Found report file: $LATEST_REPORT"
            echo "## üöÄ Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
            echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY

            PERFORMANCE=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('$LATEST_REPORT')).categories.performance.score * 100)" 2>/dev/null || echo "N/A")
            ACCESSIBILITY=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('$LATEST_REPORT')).categories.accessibility.score * 100)" 2>/dev/null || echo "N/A")
            BEST_PRACTICES=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('$LATEST_REPORT')).categories['best-practices'].score * 100)" 2>/dev/null || echo "N/A")
            SEO=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('$LATEST_REPORT')).categories.seo.score * 100)" 2>/dev/null || echo "N/A")

            echo "| üöÄ Performance | ${PERFORMANCE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ôø Accessibility | ${ACCESSIBILITY}% |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ö° Best Practices | ${BEST_PRACTICES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| üîç SEO | ${SEO}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No JSON report files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check and save Chrome cache
        if: always()
        run: |
          echo "=== Chrome Cache Debug ==="

          # Ë§áÊï∞„ÅÆÂèØËÉΩ„Å™Puppeteer„Ç≠„É£„ÉÉ„Ç∑„É•Â†¥ÊâÄ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          CACHE_PATHS=(
            "$HOME/.cache/puppeteer"
            "$HOME/.cache/ms-playwright"
            "$HOME/Library/Caches/puppeteer"
            "./node_modules/puppeteer/.local-chromium"
            "$HOME/.local/share/puppeteer"
          )

          FOUND_CACHE=""
          for path in "${CACHE_PATHS[@]}"; do
            if [ -d "$path" ] && [ -n "$(ls -A "$path" 2>/dev/null)" ]; then
              echo "‚úÖ Found Chrome cache at: $path"
              ls -la "$path"
              FOUND_CACHE="$path"
              break
            else
              echo "‚ùå No cache found at: $path"
            fi
          done

          if [ -n "$FOUND_CACHE" ]; then
            echo "CHROME_CACHE_PATH=$FOUND_CACHE" >> $GITHUB_ENV
            echo "Cache will be saved from: $FOUND_CACHE"
          else
            echo "‚ö†Ô∏è No Puppeteer cache found to save"
          fi

      - name: Save Chrome cache
        if: always() && env.CHROME_CACHE_PATH != ''
        uses: actions/cache/save@v4
        with:
          path: ${{ env.CHROME_CACHE_PATH }}
          key: ${{ runner.os }}-chrome-${{ hashFiles('**/package-lock.json') }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ github.run_id }}
          path: lighthouse-artifacts/
          if-no-files-found: ignore
          retention-days: 7
